from umqtt.simple import MQTTClient
from machine import Pin, ADC, time_pulse_us
import time
import network

# ---- WIFI ----
SSID = "Starlink Web"
PASSWORD = "wrpnaTDD0426"

# ---- MQTT ----
BROKER = "test.mosquitto.org"
PORT = 1883
CLIENT_ID = "esp32-alerta"
TOPIC = b"alerta/sensor"

# ---- Sensor humedad (ADC) ----
sensor = ADC(Pin(34))
sensor.atten(ADC.ATTN_11DB)

# ---- Ultrasonido (TRIG listo, ECHO mañana) ----
TRIG = Pin(5, Pin.OUT)
# ECHO = Pin(18, Pin.IN)   # activar mañana

def medir_distancia():
    TRIG.off()
    time.sleep_us(2)
    TRIG.on()
    time.sleep_us(10)
    TRIG.off()

    # activar mañana cuando esté el ECHO conectado con divisor:
    # duracion = time_pulse_us(ECHO, 1, 30000)
    # distancia = (duracion / 2) / 29.1
    # return distancia

    return None

def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(SSID, PASSWORD)
    while not wlan.isconnected():
        time.sleep(1)

def send_alert():
    client = MQTTClient(CLIENT_ID, BROKER, PORT)
    client.connect()
    client.publish(TOPIC, b"true")
    client.disconnect()

connect_wifi()

while True:
    valor = sensor.read()
    print("Humedad:", valor)

    if valor > 1500:
        send_alert()

    distancia = medir_distancia()
    if distancia is not None:
        print("Distancia:", distancia, "cm")
        if distancia < 20:
            send_alert()

    time.sleep(1)
